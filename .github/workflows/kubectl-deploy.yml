name: Kubernetes Deployment

on:
  workflow_run:
    workflows: [Build and Push to Artifact Registry]
    types:
      - completed

permissions:
  contents: read
  id-token: write

jobs:
  kubectl-deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: bartenders-464918
      REGION: us-east1
      REPOSITORY: docker-us
      IMAGE_NAME: bartenders

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP via OIDC
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/987774112216/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-terraform@bartenders-464918.iam.gserviceaccount.com 

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Run gcloud command
        run: gcloud info

      - name: Copy kubeconfig to /tmp
        run: |
          gcloud compute ssh k3s-vm-1 \
            --zone=us-east1-d \
            --project=bartenders-464918 \
            --ssh-flag="-T" \
            --quiet \
            --command="sudo cp /etc/rancher/k3s/k3s.yaml /tmp/k3s.yaml && sudo chmod 644 /tmp/k3s.yaml"

      - name: Fetch kubeconfig from VM
        run: |
          gcloud compute scp \
            --zone=us-east1-d \
            --project=bartenders-464918 \
            --quiet \
            k3s-vm-1:/tmp/k3s.yaml kubeconfig

      - name: Patch kubeconfig server address
        run: |
          VM_IP=$(gcloud compute instances describe k3s-vm-1 \
            --zone=us-east1-d \
            --project=bartenders-464918 \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          sed -i "s/0.0.0.0/$VM_IP/" kubeconfig

      - name: Test kubectl access
        env:
          KUBECONFIG: kubeconfig
        run: kubectl get nodes
      
      - name: Download registry key
        run: |
          gcloud iam service-accounts keys create registry_key.json \
            --iam-account=k3s-server@bartenders-464918.iam.gserviceaccount.com \
            --project=bartenders-464918

      - name: Create Docker registry secret
        env:
          KUBECONFIG: kubeconfig
        run: |
          kubectl create secret docker-registry artifact-read \
            --docker-server=us-east1-docker.pkg.dev \
            --docker-username=_json_key \
            --docker-password="$(cat registry_key.json)" \
            --docker-email=k3s-server@bartenders-464918.iam.gserviceaccount.com \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Render deployment manifest
        run: |
          export IMAGE_TAG=${{ github.sha }}
          envsubst < k3s/bartenders.yml > k3s/bartenders.rendered.yml

      - name: Apply deployment
        env:
          KUBECONFIG: kubeconfig
        run: kubectl apply -f k3s/bartenders.rendered.yml